---
title: 重複使用建議系統，以及 R 與 Azure 的演算法
author: kbaroni
ms.author: kbaroni
ms.date: 11/20/2019
ms.topic: article
ms.service: industry
description: 如何重複使用並最佳化以 R 語言撰寫的建議應用程式。 仰賴 Azure VM 上的 Machine Learning Server。
ms.openlocfilehash: c5c35de681abc52641952f8bc9e95095b9d99d97
ms.sourcegitcommit: 3b175d73a82160c4cacec1ce00c6d804a93c765d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/06/2020
ms.locfileid: "77054213"
---
# <a name="optimize-and-reuse-an-existing-recommendation-system"></a><span data-ttu-id="cc649-104">將現有的建議系統最佳化並重複使用</span><span class="sxs-lookup"><span data-stu-id="cc649-104">Optimize and reuse an existing recommendation system</span></span>  

<span data-ttu-id="cc649-105">此文件說明成功重複使用並改進以 R 撰寫之現有建議系統的程序。此程序的關鍵之處在於是 MicrosoftML 與 RevoScaleR 程式庫 (建置到 Microsoft Machine Learning Server) 的平行處理原則。</span><span class="sxs-lookup"><span data-stu-id="cc649-105">This document describes the process of successfully reusing and improving an existing recommendation system written in R. The key to this was the parallelism of the MicrosoftML and RevoScaleR libraries built into Microsoft Machine Learning Server.</span></span>

## <a name="recommendation-systems-and-r"></a><span data-ttu-id="cc649-106">建議系統與 R</span><span class="sxs-lookup"><span data-stu-id="cc649-106">Recommendation systems and R</span></span>

<span data-ttu-id="cc649-107">針對經銷商，了解消費者喜好與購買記錄是一個競爭優勢。</span><span class="sxs-lookup"><span data-stu-id="cc649-107">For a retailer, understanding consumer preferences and purchasing history is a competitive advantage.</span></span> <span data-ttu-id="cc649-108">經銷商已使用此類資料數年，並結合機器學習以指出與消費者相關的產品並提供個人化的購物體驗。</span><span class="sxs-lookup"><span data-stu-id="cc649-108">Retailers have been using such data for years, in combination with machine learning, to identify products relevant to the consumer and deliver a personalized shopping experience.</span></span> <span data-ttu-id="cc649-109">此方式稱為**產品建議**，而且它會為經銷商產生大幅的營收串流。</span><span class="sxs-lookup"><span data-stu-id="cc649-109">The approach is called **product recommendation** and it generates a significant revenue stream for retailers.</span></span> <span data-ttu-id="cc649-110">建議系統可協助回答下列問題：*這位人員接下來要監看什麼電影？此客戶可能有興趣的其他服務有哪些？此客戶會想要在何處休假？*</span><span class="sxs-lookup"><span data-stu-id="cc649-110">Recommendation systems help answer questions like: *What movie will this person watch next? What additional services is this customer likely to be interested in? Where will this customer want to vacation?*</span></span>
<span data-ttu-id="cc649-111">最近的客戶想要知道：消費者 (訂閱者) 何時將會針對其合約續約？</span><span class="sxs-lookup"><span data-stu-id="cc649-111">A recent customer wanted to know: *Will consumers (subscribers) renew their contracts?*</span></span> <span data-ttu-id="cc649-112">客戶有現有的建議模型，此模型可預測訂閱者針對合約續約的機率。</span><span class="sxs-lookup"><span data-stu-id="cc649-112">The customer had an existing recommendation model that would forecast the probability of a subscriber renewing a contract.</span></span> <span data-ttu-id="cc649-113">一旦產生預測，就會套用額外的處理以將回應分類為是、否或可能。</span><span class="sxs-lookup"><span data-stu-id="cc649-113">Once the forecast was generated, additional processing was applied to classify a response into a yes, no, or maybe.</span></span> <span data-ttu-id="cc649-114">模型回應接著會整合到話務中心商業程序。</span><span class="sxs-lookup"><span data-stu-id="cc649-114">The model response was then integrated into a call center business process.</span></span> <span data-ttu-id="cc649-115">該程序可讓服務專員提供個人化的建議給消費者。</span><span class="sxs-lookup"><span data-stu-id="cc649-115">That process enabled a service agent to deliver a personalized recommendation to the consumer.</span></span>  
<span data-ttu-id="cc649-116">有許多這個客戶早期分析產品已內建在[程式設計語言 R](https://docs.microsoft.com/machine-learning-server/rebranding-microsoft-r-server) 中，包括其建議系統核心的機器學習模型。</span><span class="sxs-lookup"><span data-stu-id="cc649-116">Many of this customer’s early analytic products were built in the [programming language R](https://docs.microsoft.com/machine-learning-server/rebranding-microsoft-r-server), including the machine learning model at the core of their recommendation system.</span></span> <span data-ttu-id="cc649-117">因為其訂閱者基底已成長，因此有資料與運算需求。</span><span class="sxs-lookup"><span data-stu-id="cc649-117">As their subscriber base has grown, so have the data and compute requirements.</span></span> <span data-ttu-id="cc649-118">在這種程度上，建議工作負載處理速度現在異常慢且難以處理。</span><span class="sxs-lookup"><span data-stu-id="cc649-118">So much so, the recommendation workload is now painfully slow and cumbersome to process.</span></span> <span data-ttu-id="cc649-119">現在 Python 逐漸成為其分析產品策略的一部分。</span><span class="sxs-lookup"><span data-stu-id="cc649-119">Now Python is increasingly a part of their analytic product strategy.</span></span> <span data-ttu-id="cc649-120">但在近期，他們必須保留其 R 投資並尋找更有效的開發與部署程序。</span><span class="sxs-lookup"><span data-stu-id="cc649-120">But for the near term, they need to preserve their R investment and find a more efficient development and deployment process.</span></span> <span data-ttu-id="cc649-121">所面臨的挑戰是使用 Azure 中的功能最佳化現有的方法。</span><span class="sxs-lookup"><span data-stu-id="cc649-121">The challenge was to optimize the existing approach using capabilities in Azure.</span></span> <span data-ttu-id="cc649-122">我們著手進行一個工作來提供並驗證建議工作負載的概念證明技術堆疊。</span><span class="sxs-lookup"><span data-stu-id="cc649-122">We embarked on a task to provide—and validate—a proof-of-concept technology stack for the recommendation workload.</span></span> <span data-ttu-id="cc649-123">在這裡，我們摘述了可為類似專案使用的一般方法。</span><span class="sxs-lookup"><span data-stu-id="cc649-123">Here we summarize a general approach that can be used for similar projects.</span></span>  

## <a name="design-goals"></a><span data-ttu-id="cc649-124">設計目標</span><span class="sxs-lookup"><span data-stu-id="cc649-124">Design goals</span></span>

<span data-ttu-id="cc649-125">關鍵優先順序是重新設計並自動化模型工作流程以提供數個優點：</span><span class="sxs-lookup"><span data-stu-id="cc649-125">A key priority was to redesign and automate the model workflow to provide several advantages:</span></span>

- <span data-ttu-id="cc649-126">較快的模型開發循環與較快的創新速度。</span><span class="sxs-lookup"><span data-stu-id="cc649-126">Faster model development cycles and faster time-to-innovate.</span></span> <span data-ttu-id="cc649-127">當資料準備與模型開發循環都有效率時，實驗量就可以增加。</span><span class="sxs-lookup"><span data-stu-id="cc649-127">When data preparation and model development cycles are efficient, the volume of experiments can increase.</span></span>  
- <span data-ttu-id="cc649-128">透過更頻繁地針對全新資料執行重新定型循環，可獲得更精確的模型結果與更好的建議。</span><span class="sxs-lookup"><span data-stu-id="cc649-128">More accurate model results and better recommendations through more frequent retraining cycles on fresh data.</span></span>
- <span data-ttu-id="cc649-129">更能調整規模的概念證明 (POC) 實作，這在各種生產環境中都能運作。</span><span class="sxs-lookup"><span data-stu-id="cc649-129">A more scalable proof-of-concept (POC) implementation—one that would work in full production.</span></span>
- <span data-ttu-id="cc649-130">較快的生產時間 (透過自動化開發、測試與部署之間的程序)。</span><span class="sxs-lookup"><span data-stu-id="cc649-130">Faster time to production by automating the processes between development, test, and deployment.</span></span> <span data-ttu-id="cc649-131">自動化也能減少作業錯誤與延遲時間。</span><span class="sxs-lookup"><span data-stu-id="cc649-131">Automation also reduces operational errors and lag times.</span></span>  

## <a name="requirements"></a><span data-ttu-id="cc649-132">需求</span><span class="sxs-lookup"><span data-stu-id="cc649-132">Requirements</span></span>

<span data-ttu-id="cc649-133">工作流程重新設計有下列需求：</span><span class="sxs-lookup"><span data-stu-id="cc649-133">The workflow redesign had the following requirements:</span></span>

- <span data-ttu-id="cc649-134">利用小組的現有 R 技術與專業。</span><span class="sxs-lookup"><span data-stu-id="cc649-134">Leverage the team’s existing R skills and expertise.</span></span>
- <span data-ttu-id="cc649-135">在適當的情況下重複使用程式碼。</span><span class="sxs-lookup"><span data-stu-id="cc649-135">Reuse code where it made sense.</span></span>
- <span data-ttu-id="cc649-136">將訂閱者資料存放在資料庫中，以輕鬆並快速地整合到模型定型與重新定型程序。</span><span class="sxs-lookup"><span data-stu-id="cc649-136">Store subscriber data in a database to be easily and quickly integrated into the model training and retraining process.</span></span>
- <span data-ttu-id="cc649-137">透過 Web 應用程式介面叫用模型重新定型與評分。</span><span class="sxs-lookup"><span data-stu-id="cc649-137">Invoke model retraining and scoring through a web app interface.</span></span>
- <span data-ttu-id="cc649-138">在 Web 前端使用 Azure Active Directory 來進行驗證。</span><span class="sxs-lookup"><span data-stu-id="cc649-138">Use Azure Active Directory for authentication on the web front end.</span></span>

## <a name="technology-stack"></a><span data-ttu-id="cc649-139">技術堆疊</span><span class="sxs-lookup"><span data-stu-id="cc649-139">Technology stack</span></span>

<span data-ttu-id="cc649-140">此專案的管線需要多種技術與工具，而且以四個區域為中心：</span><span class="sxs-lookup"><span data-stu-id="cc649-140">The pipeline for this project required multiple technologies and tools and centered around four areas:</span></span>

1. <span data-ttu-id="cc649-141">訂閱者資料的持續性與可存取性。</span><span class="sxs-lookup"><span data-stu-id="cc649-141">Persistence and accessibility of subscriber data.</span></span>
2. <span data-ttu-id="cc649-142">模型的開發、定型與選擇。</span><span class="sxs-lookup"><span data-stu-id="cc649-142">Development, training, and selection of models.</span></span>  
3. <span data-ttu-id="cc649-143">模型部署與作業化。</span><span class="sxs-lookup"><span data-stu-id="cc649-143">Model deployment and operationalization.</span></span>
4. <span data-ttu-id="cc649-144">使用 Web 應用程式來叫用評分與模型重新定型。</span><span class="sxs-lookup"><span data-stu-id="cc649-144">Use of a web application to invoke scoring and model re-training.</span></span>

<span data-ttu-id="cc649-145">下面將更詳細地討論管線圖中的技術元件。</span><span class="sxs-lookup"><span data-stu-id="cc649-145">The technology components in the pipeline diagram are discussed in more detail below.</span></span>

![最佳化架構](assets/recommendation-engine-optimization/recommendation-architecture.png)

### <a name="microsoft-machine-learning-server"></a><span data-ttu-id="cc649-147">Microsoft Machine Learning Server</span><span class="sxs-lookup"><span data-stu-id="cc649-147">Microsoft Machine Learning Server</span></span>

<span data-ttu-id="cc649-148">選取 R 工作負載的主要原因： **[RevoScaleR](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler)** 與 **Microsoft ML**。</span><span class="sxs-lookup"><span data-stu-id="cc649-148">The primary reason for selecting R workloads: **[RevoScaleR](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler)** and **Microsoft ML**.</span></span> <span data-ttu-id="cc649-149">這些套件中包含的功能會在程式碼中廣泛使用，以匯入資料、建立分類模型，以及將它們部署到生產環境。</span><span class="sxs-lookup"><span data-stu-id="cc649-149">The functions included with these packages were used extensively throughout the code to import the data, create the classification models, and deploy them into production.</span></span>
<span data-ttu-id="cc649-150">MLS 已部署在 Azure 中的兩部 Linux 虛擬機器上：一部設定為「開發」，而另一部設定為「作業」。</span><span class="sxs-lookup"><span data-stu-id="cc649-150">MLS was deployed on two Linux virtual machines in Azure: one configured for “development” and one configured for “operations.”</span></span> <span data-ttu-id="cc649-151">開發 VM 是使用更大量的記憶體與處理能力來佈建，以進行數百個模型的定型及測試。</span><span class="sxs-lookup"><span data-stu-id="cc649-151">The development VM was provisioned with significantly more memory and processing power to facilitate the training and testing of hundreds of models.</span></span> <span data-ttu-id="cc649-152">它也裝載 RStudio Server 以為遠端使用者提供輕鬆存取 RStudio IDE 的方式。</span><span class="sxs-lookup"><span data-stu-id="cc649-152">It also hosted RStudio Server to provide easy access to an RStudio IDE for remote users.</span></span> <span data-ttu-id="cc649-153">作業伺服器使在較小的 VM 上設定，此 VM 具有裝載 R 模型 (可透過 REST API 從 Web 應用程式呼叫) 所需的額外延伸模組。</span><span class="sxs-lookup"><span data-stu-id="cc649-153">The operations server was configured on a smaller VM with the additional extensions necessary to host R models that were callable from a web application through REST APIs.</span></span>

### <a name="rstudio-server"></a><span data-ttu-id="cc649-154">RStudio Server</span><span class="sxs-lookup"><span data-stu-id="cc649-154">RStudio Server</span></span>

<span data-ttu-id="cc649-155">**[RStudio Server](https://www.rstudio.com/products/rstudio/#Server)** 是 Linux 應用程式，它為遠端或膝上型電腦用戶端提供瀏覽器型介面。</span><span class="sxs-lookup"><span data-stu-id="cc649-155">**[RStudio Server](https://www.rstudio.com/products/rstudio/#Server)** is a Linux application that provides a browser-based interface for remote or laptop clients.</span></span> <span data-ttu-id="cc649-156">它在連接埠 8787 上執行，而且一旦在 Azure VM 上建立網路安全性規則之後，即可供遠端連線使用。</span><span class="sxs-lookup"><span data-stu-id="cc649-156">It runs on port 8787 and is available to remote connections once a network security rule is created on the Azure VM.</span></span> <span data-ttu-id="cc649-157">針對偏好使用 RStudio IDE 的分析師與資料科學家，提供對具有大量運算與記憶體功能之虛擬機器的存取是一個有效率的選項。</span><span class="sxs-lookup"><span data-stu-id="cc649-157">For analysts and data scientists who prefer the RStudio IDE, it can be an efficient option for providing access to virtual machine with a large compute and memory capacity.</span></span> <span data-ttu-id="cc649-158">它同時以開放原始碼版本與商業版本提供下載。</span><span class="sxs-lookup"><span data-stu-id="cc649-158">It is available for download in both source and commercial editions.</span></span>

### <a name="azure-sql-database"></a><span data-ttu-id="cc649-159">Azure SQL Database</span><span class="sxs-lookup"><span data-stu-id="cc649-159">Azure SQL Database</span></span>

<span data-ttu-id="cc649-160">一開始，訂閱者資料是存放在一個很大的 .csv 檔案中，該檔案有 500 個訂閱者的 6 百萬列購買與喜好設定資訊。</span><span class="sxs-lookup"><span data-stu-id="cc649-160">Originally, the subscriber data was stored in one very large .csv file with 6 million rows of purchasing and preference information for 500 unique subscribers.</span></span> <span data-ttu-id="cc649-161">將該資料存放在資料庫中表示可以在 R 內以更快的速度存取資料，而且也可以進行記錄篩選。</span><span class="sxs-lookup"><span data-stu-id="cc649-161">Storing the data in a database meant faster data access from within R and it would allow for filtered reads.</span></span> <span data-ttu-id="cc649-162">再也不需要匯入整個資料集進行定型或重新定型：可在資料庫來源依訂閱者篩選資料，這樣可大幅減少匯入及處理資料所需的資源。</span><span class="sxs-lookup"><span data-stu-id="cc649-162">No longer would the entire data set need to be imported for training or retraining: data would be filtered by subscriber at the database source, significantly reducing the resources needed to import and process the data.</span></span>  
<span data-ttu-id="cc649-163">Azure 中有數個受控雲端資料庫選項。</span><span class="sxs-lookup"><span data-stu-id="cc649-163">There are several managed cloud database options in Azure.</span></span> <span data-ttu-id="cc649-164">我們選擇了 [Azure SQL Database](https://docs.microsoft.com/azure/sql-database/)，因為客戶熟悉 SQL Server，而且更重要的是，未來我們計畫大規模引進 SQL Server 機器學習服務到 Azure SQL Database。</span><span class="sxs-lookup"><span data-stu-id="cc649-164">[Azure SQL Database](https://docs.microsoft.com/azure/sql-database/) was selected because of the customer’s familiarity with SQL Server and—more importantly—future plans to introduce SQL Server Machine Learning Services on a broader scale to Azure SQL Database.</span></span> <span data-ttu-id="cc649-165">[SQL Server 機器學習服務](https://docs.microsoft.com/sql/advanced-analytics/what-is-sql-server-machine-learning?view=sql-server-2017)是資料庫內功能，可用於透過預存程序執行 R 與 Python 工作負載。</span><span class="sxs-lookup"><span data-stu-id="cc649-165">[SQL Server Machine Learning Services](https://docs.microsoft.com/sql/advanced-analytics/what-is-sql-server-machine-learning?view=sql-server-2017) are in-database capabilities for executing R and Python workloads via stored procedures.</span></span>

### <a name="nodejs-and-reactjs"></a><span data-ttu-id="cc649-166">Node.js 與 React.js</span><span class="sxs-lookup"><span data-stu-id="cc649-166">Node.js and React.js</span></span>

<span data-ttu-id="cc649-167">已建立 Web 介面以叫用 R 指令碼並保護網站。</span><span class="sxs-lookup"><span data-stu-id="cc649-167">A web interface was created to invoke R scripts and secure the website.</span></span> <span data-ttu-id="cc649-168">我們選擇了 Node.js 做為網頁伺服器架構，因為它讓您在分散式環境內為 Web 應用程式提供輕量型、有效率的執行階段環境。</span><span class="sxs-lookup"><span data-stu-id="cc649-168">Node.js was selected as the web server framework because it enables a light-weight and efficient runtime environment for web applications within a distributed environment.</span></span> <span data-ttu-id="cc649-169">React 是用來建置使用者介面並位於前端，它可以呼叫裝載在網頁伺服器上的 Web 服務。</span><span class="sxs-lookup"><span data-stu-id="cc649-169">React is used to build user interfaces and sits on the front end and calls web services hosted on the web server.</span></span> <span data-ttu-id="cc649-170">據信 Node + React 可提供為模型管線進行 Web 服務原型設計的最快路徑。</span><span class="sxs-lookup"><span data-stu-id="cc649-170">It was believed Node + React would provide the quickest path for proto-typing web services for the model pipeline.</span></span>  

## <a name="infrastructure-implementation"></a><span data-ttu-id="cc649-171">基礎結構實作</span><span class="sxs-lookup"><span data-stu-id="cc649-171">Infrastructure implementation</span></span>

<span data-ttu-id="cc649-172">下一節說明如何為此專案部署伺服器基礎結構。</span><span class="sxs-lookup"><span data-stu-id="cc649-172">The sections below describe how the server infrastructure was deployed for this project.</span></span> <span data-ttu-id="cc649-173">進行正確的開發及部署就和決定要套用的模型建構方法與技術一樣重要。</span><span class="sxs-lookup"><span data-stu-id="cc649-173">Getting the right development and deployment infrastructure can be as essential as determining the modeling approach and techniques that will be applied.</span></span>

### <a name="initial-database-load"></a><span data-ttu-id="cc649-174">初始資料庫負載</span><span class="sxs-lookup"><span data-stu-id="cc649-174">Initial Database Load</span></span>

<span data-ttu-id="cc649-175">第一個步驟是將訂閱者資料從非常大的 .csv 檔案匯入到 Azure SQL Database。</span><span class="sxs-lookup"><span data-stu-id="cc649-175">The first step was to import the subscriber data from a very large .csv file into Azure SQL Database.</span></span> <span data-ttu-id="cc649-176">有多種選項可用來將資料匯入到 Azure SQL Database，如此[參考](https://blogs.msdn.microsoft.com/sqlcat/2010/07/30/loading-data-to-sql-azure-the-fast-way/) \(英文\) 所述。</span><span class="sxs-lookup"><span data-stu-id="cc649-176">There are multiple options for importing data into Azure SQL Database described in in this [reference](https://blogs.msdn.microsoft.com/sqlcat/2010/07/30/loading-data-to-sql-azure-the-fast-way/).</span></span> <span data-ttu-id="cc649-177">下面說明我們是如何辦到的：</span><span class="sxs-lookup"><span data-stu-id="cc649-177">Here is how we did it:</span></span>

1. <span data-ttu-id="cc649-178">透過 Azure 入口網站依照[這裡](https://docs.microsoft.com/azure/sql-database/sql-database-get-started-portal)的步驟建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="cc649-178">Created the database through Azure portal following steps [here](https://docs.microsoft.com/azure/sql-database/sql-database-get-started-portal).</span></span>
2. <span data-ttu-id="cc649-179">下載並使用 [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017) 從 VM 連線到資料庫。</span><span class="sxs-lookup"><span data-stu-id="cc649-179">Downloaded and used [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017) to connect to the database from the VM.</span></span>
3. <span data-ttu-id="cc649-180">選取 [SQL 匯入/匯出精靈](https://docs.microsoft.com/sql/integration-services/import-export-data/import-and-export-data-with-the-sql-server-import-and-export-wizard?view=sql-server-2017) (若您的時間有限，有其他效能更好的匯入選項)。</span><span class="sxs-lookup"><span data-stu-id="cc649-180">Selected the [SQL Import/Export Wizard](https://docs.microsoft.com/sql/integration-services/import-export-data/import-and-export-data-with-the-sql-server-import-and-export-wizard?view=sql-server-2017) (if you are time-constrained, there are more performant data import options).</span></span> <span data-ttu-id="cc649-181">請記住，匯入/匯出精靈會將資料類型從資料來源對應到目標目的地；而且在我們的案例中，所有資料元素都對應到 varchar(max) 資料類型 (在可接受的情況下)。</span><span class="sxs-lookup"><span data-stu-id="cc649-181">Keep in mind the import/export wizard maps datatypes from the data source to the target destination; and with our scenario, all data elements were mapped to a varchar(max) data type which was acceptable.</span></span> <span data-ttu-id="cc649-182">若您的案例需要不同的對應，您可以在精靈中修改資料類型 ([參考](https://docs.microsoft.com/sql/integration-services/import-export-data/data-type-mapping-in-the-sql-server-import-and-export-wizard?view=sql-server-2017))。</span><span class="sxs-lookup"><span data-stu-id="cc649-182">If your scenario requires different mappings, you can modify the datatypes in the wizard ([reference](https://docs.microsoft.com/sql/integration-services/import-export-data/data-type-mapping-in-the-sql-server-import-and-export-wizard?view=sql-server-2017)).</span></span>  
4. <span data-ttu-id="cc649-183">因為提交到資料庫的大部分查詢都會篩選 *subscriber_id* 欄位，我們已在該欄位上建立索引。</span><span class="sxs-lookup"><span data-stu-id="cc649-183">Since most queries submitted to the database would filter on the field *subscriber_id*, we created an index on that field.</span></span>

### <a name="web-application"></a><span data-ttu-id="cc649-184">Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="cc649-184">Web application</span></span>

<span data-ttu-id="cc649-185">Web 應用程式負責三個功能：</span><span class="sxs-lookup"><span data-stu-id="cc649-185">The web application is responsible for three functions:</span></span>

- <span data-ttu-id="cc649-186">驗證：Web 使用者透過 *React* 前端向 *Azure Active Directory* 驗證。</span><span class="sxs-lookup"><span data-stu-id="cc649-186">Authentication: web users authenticate against *Azure Active Directory* through the *React* front end.</span></span>
- <span data-ttu-id="cc649-187">模型評分：針對特定訂閱者，接受來自使用者的輸入資料、使用 REST API 將訂閱者資料提交到 Web 服務，該服務接著會傳回預測回應。</span><span class="sxs-lookup"><span data-stu-id="cc649-187">Model scoring: accepts input data from the user for a specific subscriber, submits the subscriber data to the web service using the REST API, which returns a prediction response.</span></span>  
- <span data-ttu-id="cc649-188">模型重新定型：接受訂閱者識別碼做為輸入，並叫用開發伺服器上的 R 指令碼以針對該訂閱者將模型重新定型。</span><span class="sxs-lookup"><span data-stu-id="cc649-188">Model re-training: accepts a subscriber identifier as input an,d invokes an R script on the development server to re-train the model for that subscriber.</span></span>

<span data-ttu-id="cc649-189">搭配 *Azure Active Directory* 實作單一登入 (SSO) 比預期更有挑戰性。</span><span class="sxs-lookup"><span data-stu-id="cc649-189">Implementing single sign-on (SSO) with *Azure Active Directory* turned out to be more of a challenge than expected.</span></span> <span data-ttu-id="cc649-190">這是單頁應用程式 (SPA) 架構使然。</span><span class="sxs-lookup"><span data-stu-id="cc649-190">This was due to the single page application (SPA) framework.</span></span> <span data-ttu-id="cc649-191">有一個特定 Azure Active Directory 程式庫是成功關鍵：[react-adal](https://github.com/salvoravida/react-adal)。</span><span class="sxs-lookup"><span data-stu-id="cc649-191">One specific Azure Active Directory library was key for success: [react-adal](https://github.com/salvoravida/react-adal).</span></span> <span data-ttu-id="cc649-192">下列參考提供實作驗證的實用指導方針：</span><span class="sxs-lookup"><span data-stu-id="cc649-192">The following references provided helpful guidance for implementing authentication:</span></span>

- [<span data-ttu-id="cc649-193">Azure AD 的驗證案例</span><span class="sxs-lookup"><span data-stu-id="cc649-193">Authentication Scenarios for Azure AD</span></span>](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios)
- [<span data-ttu-id="cc649-194">單頁應用程式</span><span class="sxs-lookup"><span data-stu-id="cc649-194">Single Page Application</span></span>](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#single-page-application-spa)

### <a name="development-vm-mls-930"></a><span data-ttu-id="cc649-195">開發 VM (MLS 9.3.0)</span><span class="sxs-lookup"><span data-stu-id="cc649-195">Development VM (MLS 9.3.0)</span></span>

<span data-ttu-id="cc649-196">開發 VM 裝載模型開發、定型與重新定型，以及分類模型的部署。</span><span class="sxs-lookup"><span data-stu-id="cc649-196">The development VM hosted model development, training and re-training, and deployment of the classification model.</span></span> <span data-ttu-id="cc649-197">Azure VM (DS13 V2) 隨著 Linux/Ubuntu 16.10 提供，而且基底 VM 中已安裝下列項目：</span><span class="sxs-lookup"><span data-stu-id="cc649-197">An Azure VM (DS13 V2) was provisioned with Linux/Ubuntu 16.10 and the following were installed to the base VM:</span></span>

- <span data-ttu-id="cc649-198">Machine Learning Server 9.3.0 (使用[這裡](https://docs.microsoft.com/machine-learning-server/install/machine-learning-server-install)\(英文\) 提供的指示)。</span><span class="sxs-lookup"><span data-stu-id="cc649-198">Machine Learning Server 9.3.0 using instructions available [here](https://docs.microsoft.com/machine-learning-server/install/machine-learning-server-install).</span></span> <span data-ttu-id="cc649-199">請務必徹底執行安裝程式驗證步驟，以確認安裝成功。</span><span class="sxs-lookup"><span data-stu-id="cc649-199">Be sure to run through the setup verification steps to confirm the installation.</span></span> <span data-ttu-id="cc649-200">因為這是開發 VM，您可以略過*啟用 Web 服務部署與遠端連線*一節。</span><span class="sxs-lookup"><span data-stu-id="cc649-200">Because this was the development VM, the section ‘*Enable web service deployment and remote connections*’ was disregarded.</span></span>
- <span data-ttu-id="cc649-201">[RStudio Server](https://www.rstudio.com/products/rstudio/download-server/) (開放原始碼版本)。</span><span class="sxs-lookup"><span data-stu-id="cc649-201">[RStudio Server](https://www.rstudio.com/products/rstudio/download-server/) (Open Source Version).</span></span> <span data-ttu-id="cc649-202">請勿重新安裝 R/r-base (它先前是隨 MLS 9.3.0 安裝)。</span><span class="sxs-lookup"><span data-stu-id="cc649-202">Be careful not to re-install R/r-base (it was installed previously with MLS 9.3.0).</span></span>  
- <span data-ttu-id="cc649-203">[新增網路安全性群組](https://docs.microsoft.com/azure/virtual-machines/windows/nsg-quickstart-portal)到 VM，以針對 RStudio Server 允許連接埠 8787 上的連入連線。</span><span class="sxs-lookup"><span data-stu-id="cc649-203">[Add a network security group](https://docs.microsoft.com/azure/virtual-machines/windows/nsg-quickstart-portal) to the VM to allow for inbound connections over port 8787 for RStudio Server.</span></span>  
- <span data-ttu-id="cc649-204">ODBC 伺服器 (負責處理開發 VM 與 Azure SQL Database 之間的通訊)。</span><span class="sxs-lookup"><span data-stu-id="cc649-204">ODBC drivers to handle the communication between the development VM and Azure SQL Database.</span></span> <span data-ttu-id="cc649-205">VM 上已安裝下列 ODBC 驅動程式：</span><span class="sxs-lookup"><span data-stu-id="cc649-205">The following odbc drivers were installed on the VM:</span></span>  
- <span data-ttu-id="cc649-206">與 Linux/ubuntu 16.10 相容的[適用於 SQL Server 17 的 ODBC 驅動程式](https://www.microsoft.com/download/details.aspx?id=56567)</span><span class="sxs-lookup"><span data-stu-id="cc649-206">The [ODBC Driver for SQL Server 17](https://www.microsoft.com/download/details.aspx?id=56567) compatible with Linux/ubuntu 16.10</span></span>  
- <span data-ttu-id="cc649-207">開放原始碼 ODBC 驅動程式 unixodbc (安裝指示：[使用 ODBC 匯入關聯式資料](https://docs.microsoft.com/machine-learning-server/r/how-to-revoscaler-data-odbc) \(英文\))。</span><span class="sxs-lookup"><span data-stu-id="cc649-207">An open source ODBC driver unixodbc with installation instructions from [Import relational data using ODBC](https://docs.microsoft.com/machine-learning-server/r/how-to-revoscaler-data-odbc).</span></span> <span data-ttu-id="cc649-208">注意：在此文章中， Ubuntu 指示中有兩個錯字。</span><span class="sxs-lookup"><span data-stu-id="cc649-208">Note: this article has two typos for Ubuntu instructions.</span></span>  
- <span data-ttu-id="cc649-209">檢查 unixodbc 是否已安裝：````Apt list –installed | grep unixODBC (should be unixodbc)````</span><span class="sxs-lookup"><span data-stu-id="cc649-209">To check if unixodbc is installed:       ````Apt list –installed | grep unixODBC (should be unixodbc)````</span></span>
      - <span data-ttu-id="cc649-210">安裝驅動程式：````sudo apt-get install unixodbc-devel unixodbc-bin unixodbc (should be unixodbc-dev)````</span><span class="sxs-lookup"><span data-stu-id="cc649-210">And to install the driver: ````sudo apt-get install unixodbc-devel unixodbc-bin unixodbc (should be unixodbc-dev)````</span></span>

### <a name="operations-vm-mls-930"></a><span data-ttu-id="cc649-211">作業 VM (MLS 9.3.0)</span><span class="sxs-lookup"><span data-stu-id="cc649-211">Operations VM (MLS 9.3.0)</span></span>

<span data-ttu-id="cc649-212">模型 Web 服務與端點上裝載的作業 VM 存放了 Swagger 檔案，並存放了分類模型的序列化版本。</span><span class="sxs-lookup"><span data-stu-id="cc649-212">The operations VM hosted the model web services and endpoints, stored the Swagger files, and stored serialized versions of the classification models.</span></span> <span data-ttu-id="cc649-213">設定與 MLS 開發伺服器非常像。</span><span class="sxs-lookup"><span data-stu-id="cc649-213">Configuration is very similar to the MLS development server.</span></span> <span data-ttu-id="cc649-214">不過，它是針對作業化所設計，這表示已安裝為 REST 端點提供服務所需的 Web 服務。</span><span class="sxs-lookup"><span data-stu-id="cc649-214">However, it is configured for operationalization which means the web services necessary to serve the REST endpoints are installed.</span></span> <span data-ttu-id="cc649-215">若要部署作業 VM，可以利用 ARM 範本來加快部署速度。</span><span class="sxs-lookup"><span data-stu-id="cc649-215">To deploy the operations VM, there are ARM templates that make deployment quick.</span></span> <span data-ttu-id="cc649-216">請參閱：[使用 ARM 設定 Microsoft Machine Learning Server 9.3 以將分析操作化](https://blogs.msdn.microsoft.com/mlserver/2018/02/27/configuring-microsoft-machine-learning-server-9-3-to-operationalize-analytics-using-arm-templates/) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="cc649-216">See: [Configuring Microsoft Machine Learning Server 9.3 to Operationalize Analytics using ARM Templates](https://blogs.msdn.microsoft.com/mlserver/2018/02/27/configuring-microsoft-machine-learning-server-9-3-to-operationalize-analytics-using-arm-templates/).</span></span> <span data-ttu-id="cc649-217">針對四個專案，已使用此 *ARM 範本*部署 [One-Box](https://github.com/Microsoft/microsoft-r/tree/master/mlserver-arm-templates/one-box-configuration/linux) 設定。</span><span class="sxs-lookup"><span data-stu-id="cc649-217">For our project, a *One-Box* configuration was deployed using this [ARM template](https://github.com/Microsoft/microsoft-r/tree/master/mlserver-arm-templates/one-box-configuration/linux).</span></span>  
<span data-ttu-id="cc649-218">在此情況下，支援模型管線所需的伺服器元件已啟動並執行。</span><span class="sxs-lookup"><span data-stu-id="cc649-218">With this, the server components to support the model pipeline were up and running.</span></span>

## <a name="model-implementation"></a><span data-ttu-id="cc649-219">模型實作</span><span class="sxs-lookup"><span data-stu-id="cc649-219">Model implementation</span></span>

<span data-ttu-id="cc649-220">有一個關鍵決策影響了此專案最終模型設計，而且那是要移至「許多模型」設計 (而非單一整合型模型)。</span><span class="sxs-lookup"><span data-stu-id="cc649-220">One key decision influenced the final model design for this project and that was to move to a “many model” design rather than a single, monolithic model.</span></span> <span data-ttu-id="cc649-221">差異：每個訂閱者都有自己的分類模型，而不是以一個大型分類模型為所有訂閱者提供服務。</span><span class="sxs-lookup"><span data-stu-id="cc649-221">The difference: each subscriber has their own classification model rather than one big classification model to serve all subscribers.</span></span> <span data-ttu-id="cc649-222">針對此客戶，這是慣用方法，因為較小的模型有較小的記憶體需求，而且在生產環境中比較容易水平調整規模。</span><span class="sxs-lookup"><span data-stu-id="cc649-222">For this customer, the approach was preferred because a smaller model had a smaller memory footprint and was easier to scale horizontally in production.</span></span>

### <a name="data-import"></a><span data-ttu-id="cc649-223">資料匯入</span><span class="sxs-lookup"><span data-stu-id="cc649-223">Data import</span></span>

<span data-ttu-id="cc649-224">模型部署所需的所有資料都存在於 *Azure SQL Database* 中。</span><span class="sxs-lookup"><span data-stu-id="cc649-224">All the data needed for model development resided in an *Azure SQL Database*.</span></span> <span data-ttu-id="cc649-225">針對模型定型與重新定型，資料匯入是在兩個階段完成：</span><span class="sxs-lookup"><span data-stu-id="cc649-225">For model training and retraining, data import was done in two stages:</span></span>

1. <span data-ttu-id="cc649-226">提交查詢到資料庫，以擷取特定 *subscriber_id* 的資料，以傳回結果集。</span><span class="sxs-lookup"><span data-stu-id="cc649-226">A query was submitted to the database to retrieve data for a specific *subscriber_id* and a result set returned.</span></span> <span data-ttu-id="cc649-227">針對資料庫的查詢存取，有兩個選項要考慮：</span><span class="sxs-lookup"><span data-stu-id="cc649-227">Two options were considered for query access to the database:</span></span>

- <span data-ttu-id="cc649-228">稱為 [RxSQLServerData](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxsqlserverdata) 的 RevoScaleR 函式</span><span class="sxs-lookup"><span data-stu-id="cc649-228">A RevoScaleR function called [RxSQLServerData](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxsqlserverdata)</span></span>
- <span data-ttu-id="cc649-229">R odbc 套件</span><span class="sxs-lookup"><span data-stu-id="cc649-229">The R odbc package</span></span>

<span data-ttu-id="cc649-230">我們決定使用 R “odbc” 程式庫，它可讓我們在資料庫層級進行資料篩選。</span><span class="sxs-lookup"><span data-stu-id="cc649-230">It was decided to use the R “odbc” library which enabled data filtering at the database level.</span></span> <span data-ttu-id="cc649-231">篩選資料庫資料表，以只顯示特定訂閱者模型中，要讀入到 R 並處理所需的最小資料列數目。</span><span class="sxs-lookup"><span data-stu-id="cc649-231">Filtering the database table for only the rows needed for a specific subscriber model minimized the number of rows to be read into R and processed.</span></span> <span data-ttu-id="cc649-232">針對每個模型進行定型與重新定型所需的記憶體、運算資源與整體時間將能減少。</span><span class="sxs-lookup"><span data-stu-id="cc649-232">That reduced the memory, compute, and overall time needed to train or retrain each model.</span></span>  

1. <span data-ttu-id="cc649-233">結果集會根據分類演算法的要求轉換為 R 資料框架，而且一些資料類型會明確從 varchar 轉換為 integer 或 numeric。</span><span class="sxs-lookup"><span data-stu-id="cc649-233">The result set was converted into an R data frame and some of the data types were explicitly converted from varchars to integers or numerics as required by the classification algorithms.</span></span> <span data-ttu-id="cc649-234">針對此功能，我們使用 RevoScaleR 函式 [rxImport](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rximport)。</span><span class="sxs-lookup"><span data-stu-id="cc649-234">For this functionality, the RevoScaleR function [rxImport](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rximport) was used.</span></span> <span data-ttu-id="cc649-235">*rxImport* 函式隨附於 RevoScaleR 與 MicrosoftML 中，而且設計為支援多執行緒。</span><span class="sxs-lookup"><span data-stu-id="cc649-235">The *rxImport* function is bundled with RevoScaleR and MicrosoftML and is engineered to be multi-threaded.</span></span> <span data-ttu-id="cc649-236">以下是我們使用它的範例：</span><span class="sxs-lookup"><span data-stu-id="cc649-236">Here is an example of how we used it:</span></span>

````r

# Populate the data frame and modify column types as needed
input_data <- rxImport(sqlServerDataDS, colClasses = c(  
Approved="integer",
      OnTimeArrivalRate="numeric",
      Amount="numeric",
      IsInformed="numeric",
      <continue with list of columns> )
# View the characteristics of the variables in the data source
rxGetInfo (input_data, getVarInfo = TRUE)
````

## <a name="unbalanced-data"></a><span data-ttu-id="cc649-237">不對稱的資料</span><span class="sxs-lookup"><span data-stu-id="cc649-237">Unbalanced data</span></span>

<span data-ttu-id="cc649-238">因為建議模型的目標是預測客戶針對合約續約的機率並將機率分類為「是」、「否」或「可能」，我們將使用分類演算法。</span><span class="sxs-lookup"><span data-stu-id="cc649-238">Because the goal of the recommendation model was to forecast the probability a customer would renew a contract and categorize the probability it into a ‘yes’, ‘no’, or ‘maybe’, a classification algorithm was used.</span></span> <span data-ttu-id="cc649-239">一個可能會嚴重影響分類演算法精確度與效能的問題不對稱的資料集。</span><span class="sxs-lookup"><span data-stu-id="cc649-239">One problem that can seriously impact the accuracy and performance of a classification algorithm is an unbalanced data set.</span></span>  
<span data-ttu-id="cc649-240">若資料集中某個「類別」的樣本數目遠大於另一個「類別」中的樣本數目，我們將它稱為「不對稱的資料集」。</span><span class="sxs-lookup"><span data-stu-id="cc649-240">A data set is unbalanced if there are many more samples for one ‘class’ than another ‘class’.</span></span> <span data-ttu-id="cc649-241">在此案例中，可供每個訂閱者使用的資料列數目不對稱：在高的那一端。一個訂閱者有 1 百萬個以上的資料列；在低的那一端， 330 個客戶的資料少於 100 列。</span><span class="sxs-lookup"><span data-stu-id="cc649-241">In this case, the number of rows available for each subscriber was unbalanced: on the high end, one subscriber had 1 million+ rows; on the low end, 330 customers had less than 100 rows of data.</span></span> <span data-ttu-id="cc649-242">下圖顯示每個訂閱者的資料列 (樣本) 數不對稱的情況：![imbalance-chart](assets/recommendation-engine-optimization/recommendaton_engine_chart.png)</span><span class="sxs-lookup"><span data-stu-id="cc649-242">The graph below shows the imbalance with the number of rows (samples) per subscriber: ![imbalance-chart](assets/recommendation-engine-optimization/recommendaton_engine_chart.png)</span></span>

<span data-ttu-id="cc649-243">一個可用於處理不對稱資料集的技巧是變更資料集並為代表性不足的類別進行過度取樣，或為代表性過高的類別進行低度取樣。</span><span class="sxs-lookup"><span data-stu-id="cc649-243">One technique for treating an unbalanced data set is to change the data set and either over-sample the under-represented class, or under-sample the over-represented class.</span></span> <span data-ttu-id="cc649-244">另一個技巧是使用資料擁有者對資料所具有的精確知識與其屬性，以合成方式產生額外的資料。</span><span class="sxs-lookup"><span data-stu-id="cc649-244">Another technique is to synthetically generate additional data using the data owner’s exact knowledge of the data and its attributes.</span></span> <span data-ttu-id="cc649-245">客戶為訂閱者建立了最小樣本大小的閾值。</span><span class="sxs-lookup"><span data-stu-id="cc649-245">The customer established a threshold for the minimum sample size for a subscriber.</span></span> <span data-ttu-id="cc649-246">針對低於閾值的訂閱者，必須處理資料。</span><span class="sxs-lookup"><span data-stu-id="cc649-246">For subscribers below that threshold, data would need to be treated.</span></span> <span data-ttu-id="cc649-247">針對此專案，我們同時探索了這兩個方法。</span><span class="sxs-lookup"><span data-stu-id="cc649-247">For this project both approaches were explored.</span></span>

## <a name="algorithm-selection"></a><span data-ttu-id="cc649-248">演算法選擇</span><span class="sxs-lookup"><span data-stu-id="cc649-248">Algorithm Selection</span></span>

<span data-ttu-id="cc649-249">已評估三個不同的分類演算法實作：*rxDForest*、*rxFastTrees* 與 *rxFastForest*。</span><span class="sxs-lookup"><span data-stu-id="cc649-249">Three different classification algorithm implementations were evaluated: *rxDForest*, *rxFastTrees*, and *rxFastForest*.</span></span> <span data-ttu-id="cc649-250">這三個演算法都能發揮多執行緒處理與平行處理原則的優點。</span><span class="sxs-lookup"><span data-stu-id="cc649-250">All three algorithms take advantage of multi-threading and parallelism.</span></span> <span data-ttu-id="cc649-251">此外，Microsoft ML 將使用多顆 CPU 或 GPU (如果可用的話)。</span><span class="sxs-lookup"><span data-stu-id="cc649-251">And Microsoft ML will use multiple CPUs or GPUs if available.</span></span> <span data-ttu-id="cc649-252">用於評估模型的準則包括：</span><span class="sxs-lookup"><span data-stu-id="cc649-252">The criteria for evaluating the models included:</span></span>

- <span data-ttu-id="cc649-253">新模型是否比原始模型更精確？</span><span class="sxs-lookup"><span data-stu-id="cc649-253">Were the new models more accurate that the original model?</span></span>
- <span data-ttu-id="cc649-254">在生產環境中執行之模型對記憶體資源的需求度如何？</span><span class="sxs-lookup"><span data-stu-id="cc649-254">What was the memory footprint of the models running in production?</span></span> <span data-ttu-id="cc649-255">在不影響精確度的情況下，作業環境是否能支援以近乎即時的預測回應模式同時執行許多模型？</span><span class="sxs-lookup"><span data-stu-id="cc649-255">Without compromising accuracy, could the operational environment support simultaneous execution of many models with near real-time prediction response?</span></span>
- <span data-ttu-id="cc649-256">演算法處理不對稱資料集的完善程度為何？</span><span class="sxs-lookup"><span data-stu-id="cc649-256">How well did the algorithm handle the unbalanced data set?</span></span> <span data-ttu-id="cc649-257">是否應該透過產生合成資料來處理不對稱問題？</span><span class="sxs-lookup"><span data-stu-id="cc649-257">Would the imbalance need to be pre-treated by generating synthetic data?</span></span>

<span data-ttu-id="cc649-258">下表摘述差異我們發現的結果：</span><span class="sxs-lookup"><span data-stu-id="cc649-258">The table below summarizes the findings:</span></span>

| <span data-ttu-id="cc649-259">演算法</span><span class="sxs-lookup"><span data-stu-id="cc649-259">Algorithm</span></span> | <span data-ttu-id="cc649-260">描述</span><span class="sxs-lookup"><span data-stu-id="cc649-260">Description</span></span> | <span data-ttu-id="cc649-261">結果</span><span class="sxs-lookup"><span data-stu-id="cc649-261">Findings</span></span> | <span data-ttu-id="cc649-262">注意</span><span class="sxs-lookup"><span data-stu-id="cc649-262">Notes</span></span> |
| :--------- | :------------ | :--------- | :--------------- |
| [<span data-ttu-id="cc649-263">rxFastTrees</span><span class="sxs-lookup"><span data-stu-id="cc649-263">rxFastTrees</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/microsoftml/rxfasttrees) | <span data-ttu-id="cc649-264">推進式決策樹的平行處理原則實作 (它實作 FastRank 的多執行緒版本)。</span><span class="sxs-lookup"><span data-stu-id="cc649-264">Parallel implementation of boosted decision tree that implements multi-threaded version of FastRank.</span></span> | <span data-ttu-id="cc649-265">精確、最快的效能。</span><span class="sxs-lookup"><span data-stu-id="cc649-265">Accurate, fastest performance.</span></span> | <span data-ttu-id="cc649-266">沒有不對稱資料的特殊功能。</span><span class="sxs-lookup"><span data-stu-id="cc649-266">No special features for unbalanced data.</span></span> <span data-ttu-id="cc649-267">必須提供預先處理的資料做為輸入</span><span class="sxs-lookup"><span data-stu-id="cc649-267">Pre-treated data needed to be provided as input</span></span> |
| [<span data-ttu-id="cc649-268">rxFastForest</span><span class="sxs-lookup"><span data-stu-id="cc649-268">rxFastForest</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/microsoftml/rxfastforest) | <span data-ttu-id="cc649-269">隨機樹系的平行處理原則實作，並使用 rxFastTrees 來建置決策樹的整體 學習人員。</span><span class="sxs-lookup"><span data-stu-id="cc649-269">Parallel implementation of random forest and uses rxFastTrees to build an ensemble learner of decision trees.</span></span> | <span data-ttu-id="cc649-270">使用預先處理的資料時，精確度比原始模型好。</span><span class="sxs-lookup"><span data-stu-id="cc649-270">Better accuracy than original with pre-treated data.</span></span> <span data-ttu-id="cc649-271">所需記憶體體資源較少，比 rxDForest 快</span><span class="sxs-lookup"><span data-stu-id="cc649-271">Less memory intensive, faster than rxDForest</span></span> |<span data-ttu-id="cc649-272">沒有不對稱資料的特殊功能。</span><span class="sxs-lookup"><span data-stu-id="cc649-272">No special features for unbalanced data.</span></span> <span data-ttu-id="cc649-273">提供預先處理的資料做為輸入。</span><span class="sxs-lookup"><span data-stu-id="cc649-273">Pre-treated data provided as input.</span></span> |
| [<span data-ttu-id="cc649-274">rxDForest</span><span class="sxs-lookup"><span data-stu-id="cc649-274">rxDForest</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxdforest) | <span data-ttu-id="cc649-275">隨機樹系的平行處理原則實作。</span><span class="sxs-lookup"><span data-stu-id="cc649-275">Parallel implementation of random forest.</span></span> <span data-ttu-id="cc649-276">包括在 RevoScaleR 中。</span><span class="sxs-lookup"><span data-stu-id="cc649-276">Included in RevoScaleR.</span></span> <span data-ttu-id="cc649-277">可以完全在函式呼叫內處理不對稱資料 (移除缺少的資料、使資料符合需求、處理樣本的階層)。</span><span class="sxs-lookup"><span data-stu-id="cc649-277">Can deal with unbalanced data (removes missing data, conditions data, handles stratification of samples) all within the function call.</span></span> | <span data-ttu-id="cc649-278">比原始模型更快。</span><span class="sxs-lookup"><span data-stu-id="cc649-278">Faster than original model.</span></span> <span data-ttu-id="cc649-279">精確度等於或高於原始模型。</span><span class="sxs-lookup"><span data-stu-id="cc649-279">Same or better accuracy than original model.</span></span> <span data-ttu-id="cc649-280">使用各種技巧來重新取樣及合成，以處理不對稱的資料集。</span><span class="sxs-lookup"><span data-stu-id="cc649-280">Handles unbalanced data set using a variety of techniques for re-sampling and synthesizing.</span></span> <span data-ttu-id="cc649-281">高記憶體使用量。</span><span class="sxs-lookup"><span data-stu-id="cc649-281">Largest memory footprint.</span></span>  | <span data-ttu-id="cc649-282">高記憶體使用量，因為它在函式內包括條件式資料。</span><span class="sxs-lookup"><span data-stu-id="cc649-282">Largest memory footprint because it includes the conditioned data within the function.</span></span>   <span data-ttu-id="cc649-283">針對資料進行處理很好，但沒有比由資料擁有者所提供的自訂轉換還好。</span><span class="sxs-lookup"><span data-stu-id="cc649-283">Treatment of the data was good but not as good as the customized transformations provided by the data owner.</span></span> |

<span data-ttu-id="cc649-284">最後，客戶選擇 *rxFastForest* 演算法並決定處理不對稱的資料 (透過使用 [vtreat](https://cran.r-project.org/web/packages/vtreat/index.html) 程式庫並針對代表性不足的訂閱者新增自訂資料預先處理步驟以合成方式產生資料。</span><span class="sxs-lookup"><span data-stu-id="cc649-284">In the end, the customer selected the *rxFastForest* algorithm and decided to treat the unbalanced data by using the [vtreat](https://cran.r-project.org/web/packages/vtreat/index.html) library and adding a customized data pre-processing step to synthetically generate data for the under-represented subscribers.</span></span>

## <a name="model-deployment--web-services"></a><span data-ttu-id="cc649-285">模型部署與 Web 服務</span><span class="sxs-lookup"><span data-stu-id="cc649-285">Model Deployment & Web Services</span></span>

<span data-ttu-id="cc649-286">發行模型到作業 VM 部署是一個很直覺的動作，而且記載在此快速入門文件中：[使用 mrsdeploy 將 R 模型部署為 Web 服務](https://docs.microsoft.com/machine-learning-server/operationalize/quickstart-publish-r-web-service) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="cc649-286">Publishing a model for deployment to the operations VM is straight-forward and documented in this QuickStart documentation [Deploy an R Model as a web service with mrsdeploy](https://docs.microsoft.com/machine-learning-server/operationalize/quickstart-publish-r-web-service).</span></span>
<span data-ttu-id="cc649-287">在我們的案例中，一旦在開發 VM 上建立模型，就會使用下列步驟在作業 VM 上發行它們：</span><span class="sxs-lookup"><span data-stu-id="cc649-287">In our scenario, once the models were created on the development VM, they were published on the operations VM using these steps:</span></span>

1. <span data-ttu-id="cc649-288">使用 mrsdeploy 套件中兩個函式的其中一個進行驗證，以建立從開發人員 VM 連線到作業 VM 的遠端登入：remoteLogin() - 使用本機系統管理員名稱與密碼，或 remoteLoginAAD() - 使用 Azure Active Directory。</span><span class="sxs-lookup"><span data-stu-id="cc649-288">Establish a remote login from the developer VM to the operations VM using one of two functions available in the mrsdeploy package for authentication; remoteLogin() using a local admin name and password, or remoteLoginAAD() using Azure Active Directory.</span></span> <span data-ttu-id="cc649-289">＜使用 mrsdeploy 並開啟遠端工作階段以登入 Machine Learning Server 或 R Server＞參考中說明上述兩個選項。</span><span class="sxs-lookup"><span data-stu-id="cc649-289">Both options are described in this reference Log in to Machine Learning Server or R Server with mrsdeploy and open a remote session.</span></span>  
2. <span data-ttu-id="cc649-290">一旦將模型定型，使用 mrsdeploy 套件中的 publishService 或 updateService 函式將它發行到作業 VM。</span><span class="sxs-lookup"><span data-stu-id="cc649-290">Once a model is trained, publish it to the operations VM using the publishService or updateService functions in the mrsdeploy package.</span></span> <span data-ttu-id="cc649-291">針對此專案，我們使用多個部署方法，而且視所使用的方法而定，我們發行了新模型或更新現有的模型。</span><span class="sxs-lookup"><span data-stu-id="cc649-291">For this project, we used multiple deployment approaches, and—depending on the approach—either a new model was published, or an existing model was updated.</span></span> <span data-ttu-id="cc649-292">已實作下列程式碼以處理這兩個案例：</span><span class="sxs-lookup"><span data-stu-id="cc649-292">The following code was implemented to handle both cases:</span></span>

````r
# If the service does not exist, publish it and if it does exist, update it.  
# No service by this name so publish one
 api <- publishService(serviceName, code =sc_predict, model = model,  
      inputs = list(prop_data="data.frame"),  
      outputs = list(answer = "numeric"), v = "v1.0.0" )
 print("=========== Model Created =============")
} else {
# A service by this name already exists, update it  
 api <- updateService(serviceName, model = model,
     inputs = list(prop_data="data.frame"), v = "v1.0.0" )
 print("=========== Model Updated =============")
}
 ````

當部署時，模型會序列化並存放在作業伺服器上，而且可透過 Web 服務以「標準」或「即時」模式取用。 每次以標準模式呼叫 Web 服務時，都會載入 R 與任何必要程式庫，並透過每個呼叫來卸載。 相反地，使用「即時」模式時，R 與程式庫只會載入一次，並由後續 Web 服務呼叫重複使用。 因為 Web 服務呼叫的大部分額外負擔是載入 R 與程式庫，即時模式提供有關模型評分的較短延遲，而且回應時間可以在 10 毫秒以下。 針對標準與即時選項，請參閱[這裡](https://docs.microsoft.com/machine-learning-server/operationalize/concept-what-are-web-services)的文件與參考範例。 即時可用於進行單次預測，但您也可以傳入輸入資料框架以進行評分。 <span data-ttu-id="cc649-299">此參考提供進一步的說明：[透過批次處理的非同步 Web 服務 (使用 mrsdeploy)](https://docs.microsoft.com/machine-learning-server/operationalize/how-to-consume-web-service-asynchronously-batch) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="cc649-299">That is described in this reference: [Asynchronous web service consumption via batch processing with mrsdeploy](https://docs.microsoft.com/machine-learning-server/operationalize/how-to-consume-web-service-asynchronously-batch).</span></span>

## <a name="conclusion"></a><span data-ttu-id="cc649-300">結論</span><span class="sxs-lookup"><span data-stu-id="cc649-300">Conclusion</span></span>

<span data-ttu-id="cc649-301">利用建置在 Microsoft Machine Learning Server 中的 MicrosoftML 與 RevoScaleR 程式庫的平行處理原則來加快為數百個訂閱者開發、部署個別分類模型及為其評分的速度。</span><span class="sxs-lookup"><span data-stu-id="cc649-301">Leveraging the parallelism of the MicrosoftML and RevoScaleR libraries built into Microsoft Machine Learning Server accelerated development, deployment, and scoring of individual classification models for hundreds of subscribers.</span></span> <span data-ttu-id="cc649-302">模型精確度已改進，而且定型及重新定型時間已縮短，這所有一切都是在對現有 R 程式碼基底進行最少變更的情況下完成的。</span><span class="sxs-lookup"><span data-stu-id="cc649-302">Model accuracy improved, and training and re-training times were compressed—all with minimal changes to the existing R code base.</span></span>
<span data-ttu-id="cc649-303">實作基礎結構以支援模型管線並正確設定端對端技術元件可能很複雜。</span><span class="sxs-lookup"><span data-stu-id="cc649-303">Implementing the infrastructure to support a model pipeline and getting the technology components configured correctly end-to-end can be complex.</span></span> <span data-ttu-id="cc649-304">以下是一些能協助您以自己的方式開始的參資料考：</span><span class="sxs-lookup"><span data-stu-id="cc649-304">Here are some references to get your started with your own approach:</span></span>

- <span data-ttu-id="cc649-305">[Machine Learning Server 文件](https://docs.microsoft.com/machine-learning-server/) \(英文\)</span><span class="sxs-lookup"><span data-stu-id="cc649-305">[Machine Learning Server Documentation](https://docs.microsoft.com/machine-learning-server/)</span></span>
- <span data-ttu-id="cc649-306">[Machine Learning Server 的 R 教學課程](https://docs.microsoft.com/advanced-analytics/tutorials/sql-server-r-tutorials?view=sql-server-2017) \(英文\)</span><span class="sxs-lookup"><span data-stu-id="cc649-306">[R Tutorials for Machine Learning Server](https://docs.microsoft.com/advanced-analytics/tutorials/sql-server-r-tutorials?view=sql-server-2017)</span></span>
- <span data-ttu-id="cc649-307">[Machine Learning Server 的 R 範例](https://docs.microsoft.com/machine-learning-server/r/r-samples) \(英文\)</span><span class="sxs-lookup"><span data-stu-id="cc649-307">[R Samples for Machine Learning Server](https://docs.microsoft.com/machine-learning-server/r/r-samples)</span></span>
- <span data-ttu-id="cc649-308">[R 函式程式庫參考](https://docs.microsoft.com/machine-learning-server/r-reference/introducing-r-server-r-package-reference) \(英文\)</span><span class="sxs-lookup"><span data-stu-id="cc649-308">[R Function Library Reference](https://docs.microsoft.com/machine-learning-server/r-reference/introducing-r-server-r-package-reference)</span></span>

## <a name="references"></a><span data-ttu-id="cc649-309">參考</span><span class="sxs-lookup"><span data-stu-id="cc649-309">References</span></span>

<span data-ttu-id="cc649-310">若您對於為您的零售業務建置其他預測性解決方案有興趣，請瀏覽 Azure [AI Gallery](https://gallery.azure.ai/industries/retail) \(英文\) 的[零售驅動](https://gallery.azure.ai/)。</span><span class="sxs-lookup"><span data-stu-id="cc649-310">If you are interested in building other predictive solutions for your retail business, visit the [retail section](https://gallery.azure.ai/industries/retail) of the Azure [AI Gallery](https://gallery.azure.ai/).</span></span>  